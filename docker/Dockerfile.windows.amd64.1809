# escape=`

# First stage for downloading JFrog CLI and certificates
FROM mcr.microsoft.com/windows/servercore:1809 AS builder
SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

# Create necessary directories
RUN mkdir C:\bin | Out-Null; `
    mkdir C:\certificates | Out-Null; `
    mkdir -Path C:\users\ContainerUser\.jfrog\security\certs | Out-Null

# Copy CA certificates
COPY docker/cert.windows.pem docker/cacert.pem C:\users\ContainerUser\.jfrog\security\certs\

# Generate CA certificates
RUN certutil -generateSSTFromWU C:\certificates\ca-certificates.sst

# Download JFrog CLI
RUN Invoke-WebRequest -Uri https://releases.jfrog.io/artifactory/jfrog-cli/v2/2.68.0/jfrog-cli-windows-amd64/jfrog.exe -OutFile C:\bin\jfrog.exe

# Final image using Nanoserver - much smaller base image
FROM mcr.microsoft.com/windows/nanoserver:1809

# Create directories and set permissions
USER ContainerAdministrator
RUN mkdir C:\bin C:\certificates C:\temp

# Copy certificates and JFrog CLI from builder stage
COPY --from=builder C:\certificates C:\certificates
COPY --from=builder C:\users\ContainerUser\.jfrog C:\users\ContainerUser\.jfrog
COPY --from=builder C:\bin\jfrog.exe C:\bin\jfrog.exe

# Set environment variables
ENV GODEBUG=netdns=go
ENV PATH="C:\bin;C:\Windows\System32;C:\Windows"
ENV TEMP="C:\temp"
ENV TMP="C:\temp"

# Add plugin executable
ADD release/windows/amd64/plugin C:/bin/drone-artifactory.exe

ENTRYPOINT [ "C:\\bin\\drone-artifactory.exe" ]
